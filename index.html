<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TurtleBot Web Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/eventemitter2/lib/eventemitter2.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/easeljs/lib/easeljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ros2d/build/ros2d.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three/build/three.min.js"></script>
</head>
<body>
  <h1>TurtleBot Web Dashboard</h1>

  <!-- Camera, Map, and Velocity side by side -->
  <div style="display:flex; gap:20px; align-items:flex-start; flex-wrap:wrap;">
    <div>
      <h2>RGB Camera (Waffle Pi)</h2>
      <iframe src="http://localhost:8080/stream?topic=/waffle_pi/camera/rgb/image_raw"
              width="400" height="400" style="border:1px solid #000;"></iframe>
    </div>
    <div>
      <h2>Map Visualization</h2>
      <div id="nav2dmap" style="width:400px;height:400px;border:1px solid #000;overflow:hidden;"></div>
    </div>
    <div style="max-width:250px;">
      <h2>Velocity Data</h2>
      <div id="cmdvel-box"
           style="border:1px solid #000;padding:10px;word-wrap:break-word;">
        Waiting for /waffle_pi/cmd_vel messages...
      </div>
      <h2>Odometry</h2>
      <div id="poseX"></div>
      <div id="poseY"></div>
      <div id="poseTheta"></div>
      <div id="poseLinVel"></div>
      <div id="poseAngVel"></div>
    </div>
  </div>

  <!-- Teleop buttons -->
  <h2>Teleop Control</h2>
  <div>
    <button id="upButton">Up</button>
    <button id="downButton">Down</button>
    <button id="leftButton">Left</button>
    <button id="rightButton">Right</button>
  </div>

  <script>
    // Connect to rosbridge
    var ros = new ROSLIB.Ros({ url: 'ws://localhost:9090' });

    // Velocity listener
    var cmdVelListener = new ROSLIB.Topic({
      ros: ros,
      name: '/waffle_pi/cmd_vel',
      messageType: 'geometry_msgs/Twist'
    });
    cmdVelListener.subscribe(function(msg) {
        document.getElementById("cmdvel-box").innerText =
          "Linear X: " + msg.linear.x.toFixed(2) +
          "\nLinear Y: " + msg.linear.y.toFixed(2) +
          "\nLinear Z: " + msg.linear.z.toFixed(2) +
          "\nAngular X: " + msg.angular.x.toFixed(2) +
          "\nAngular Y: " + msg.angular.y.toFixed(2) +
          "\nAngular Z: " + msg.angular.z.toFixed(2);
    });

    // Teleop publisher
    var cmdVelTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/waffle_pi/cmd_vel',
      messageType: 'geometry_msgs/Twist'
    });
    var twist = new ROSLIB.Message({ linear:{x:0,y:0,z:0}, angular:{x:0,y:0,z:0} });
   
    let intervalId = null;
    
    function startMoving(linVel, angVel) {
      if (intervalId) clearInterval(intervalId);
      intervalId = setInterval(() => {
        twist.linear.x = linVel;
        twist.linear.y = 0;
        twist.linear.z = 0;
        twist.angular.x = 0;
        twist.angular.y = 0;
        twist.angular.z = angVel;
        cmdVelTopic.publish(twist);
      }, 50);
    }
    
    function stopMoving() {
      if (intervalId) clearInterval(intervalId);
      twist.linear.x = 0;
      twist.angular.z = 0;
      cmdVelTopic.publish(twist);
    }

    document.getElementById('upButton').onmousedown = () => startMoving(0.2,0);
    document.getElementById('upButton').onmouseup = stopMoving;
    document.getElementById('downButton').onmousedown = () => startMoving(-0.2,0);
    document.getElementById('downButton').onmouseup = stopMoving;
    document.getElementById('leftButton').onmousedown = () => startMoving(0,0.5);
    document.getElementById('leftButton').onmouseup = stopMoving;
    document.getElementById('rightButton').onmousedown = () => startMoving(0,-0.5);
    document.getElementById('rightButton').onmouseup = stopMoving;

    // Map viewer
    var viewer = new ROS2D.Viewer({ divID:'nav2dmap', width:400, height:400 });
    var gridClient = new ROS2D.OccupancyGridClient({
      ros: ros,
      rootObject: viewer.scene,
      continuous: true,
      topic: '/map'
    });

    gridClient.on('change', function() {
      viewer.scaleToDimensions(gridClient.currentGrid.width, gridClient.currentGrid.height);
      viewer.shift(gridClient.currentGrid.pose.position.x, gridClient.currentGrid.pose.position.y);
      viewer.scene.rotation = -90;
      viewer.scene.scaleX *= 3;
      viewer.scene.scaleY *= 3;
    });

    // Robot pose arrow
    var robotArrow = new ROS2D.NavigationArrow({
      size: 0.1, strokeSize: 0.01, strokeStyle: "#00FF00", pulse: false
    });
    viewer.scene.addChild(robotArrow);

    var robotPoseTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/robot_pose',
      messageType: 'geometry_msgs/Pose'
    });
    robotPoseTopic.subscribe(function(pose) {
      robotArrow.x = pose.position.x;
      robotArrow.y = -pose.position.y;
      var q = new THREE.Quaternion(
        pose.orientation.x, pose.orientation.y,
        pose.orientation.z, pose.orientation.w
      );
      var euler = new THREE.Euler().setFromQuaternion(q, 'ZYX');
      robotArrow.rotation = euler.z * (180/Math.PI) - 90;
    });

    // Odometry listener
    var odomTopic = new ROSLIB.Topic({
      ros: ros,
      name: '/waffle_pi/odom',
      messageType: 'nav_msgs/Odometry'
    });
    odomTopic.subscribe(function(msg) {
      document.getElementById('poseX').innerText = "X = " + msg.pose.pose.position.x.toFixed(2);
      document.getElementById('poseY').innerText = "Y = " + msg.pose.pose.position.y.toFixed(2);
      document.getElementById('poseTheta').innerText = "Theta (w) = " + msg.pose.pose.orientation.w.toFixed(2);
      document.getElementById('poseLinVel').innerText = "LinVel = " + msg.twist.twist.linear.x.toFixed(2);
      document.getElementById('poseAngVel').innerText = "AngVel = " + msg.twist.twist.angular.z.toFixed(2);
    });
  </script>
</body>
</html>
